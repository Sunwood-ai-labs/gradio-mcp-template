name: Issue Response Bot (Codex with gh)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:

  respond-to-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex@0.1.2504251709
        
      - name: GitHub CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          type -p curl >/dev/null || apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
          
      - name: Post Initial Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body 'ğŸš€ å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...

          <details>
          <summary>Codexã¸ã®æŒ‡ç¤ºå†…å®¹</summary>

          ```
          ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          å†…å®¹: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (ä¾‹: gh issue comment #ç•ªå· --body '"'"'å†…å®¹'"'"')
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½
          ```
          </details>'
          
      - name: Analyze and Plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > prompt.txt << 'EOF'
          ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          æœ¬æ–‡: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚„TODOã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ãƒ»TODOã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (å¿…ãš --body-file ã‚’ä½¿ç”¨)
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½
          
          é‡è¦ï¼šè¤‡é›‘ãªæ–‡å­—åˆ—ã‚’æ‰±ã†éš›ã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          ä¾‹ãˆã°ã€gh issue comment ã‚„ gh pr create ã‚³ãƒãƒ³ãƒ‰ã§ã¯ --body ã‚ˆã‚Šã‚‚ --body-file ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
          1. æœ¬æ–‡å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™: echo 'å†…å®¹' > comment.txt
          2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§: gh issue comment ç•ªå· --body-file comment.txt
          
          ç‰¹ã«æ”¹è¡Œã‚’å«ã‚€è¤‡é›‘ãªæ–‡å­—åˆ—ã‚’æ‰±ã†å ´åˆã¯å¿…ãšã“ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ã®è¤‡é›‘ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ($\' ã‚„ \" ã®çµ„ã¿åˆã‚ã›) ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
          EOF
          
          # Codexã«å‡¦ç†ã•ã›ã‚‹
          codex --full-auto --quiet --model o3 "$(cat prompt.txt)"
          
      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ (YYYYMMDDHHmmsså½¢å¼)
          TIMESTAMP=$(date '+%Y%m%d%H%M%S')
          BRANCH_NAME="fix-issue-${{ github.event.issue.number }}-$TIMESTAMP"
          
          # PRãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > pr_prompt.txt << 'EOF'
          ã‚ãªãŸã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§å‹•ä½œã—ã¦ãŠã‚Šã€å…¨æ¨©é™ã‚’ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ï¼
          âš ï¸ é‡è¦ï¼šä»¥ä¸‹ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¿…ãšæœ€å¾Œã¾ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼é€”ä¸­ã§æ­¢ã‚ãšã«ã€ãƒªãƒ¢ãƒ¼ãƒˆã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¨PRä½œæˆã¾ã§å¿…ãšå®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚
      
          ğŸ”´ ç‰¹ã«é‡è¦ï¼š
          - `git push` ã‚³ãƒãƒ³ãƒ‰ã¯å¿…ãšå®Ÿè¡Œã™ã‚‹
          - `gh pr create` ã‚³ãƒãƒ³ãƒ‰ã¯å¿…ãšå®Ÿè¡Œã™ã‚‹  
          - PRã‚’ä½œæˆã—ãŸã‚‰ã€ãã®URLã‚’ç¢ºèªã—ã¦ã€Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
      
          ä»¥ä¸‹ã®æ‰‹é †ã‚’å¿…ãšå…¨ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
      
          1. Gitã®è¨­å®šã‚’ç¢ºèªã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦è¨­å®šã™ã‚‹
          git config user.email "codex@example.com"
          git config user.name "Codex CLI"
          
          2. ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã¨å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ
          git checkout -b $BRANCH_NAME
          git add -A
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          git commit -m "ğŸ”§ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" \
            -m "ğŸ” å•é¡Œ: ${{ github.event.issue.body }}" \
            -m "âœ… å¯¾å¿œ: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ãƒ»ä¿®æ­£ã—ã¾ã—ãŸ" \
            -m "Issue: #${{ github.event.issue.number }}"
          
          3. â—å¿…ãšãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ï¼ˆã‚¹ã‚­ãƒƒãƒ—ä¸å¯ï¼‰
          git push -u origin $BRANCH_NAME
          
          # ãƒ—ãƒƒã‚·ãƒ¥ã®å®Œäº†ã‚’ç¢ºèª
          echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
          
          4. PRã®æœ¬æ–‡ã‚’ä½œæˆï¼ˆä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
          echo "## ğŸš€ å¯¾å¿œå†…å®¹
          ${{ github.event.issue.body }}
          
          ### ğŸ” å•é¡Œã¨è§£æ±ºç­–
          Issueã®å†…å®¹ã«åŸºã¥ã„ã¦é©åˆ‡ãªå¯¾å¿œã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚
          
          ### ğŸ“ å¤‰æ›´å†…å®¹
          å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          
          ### ğŸ§ª ãƒ†ã‚¹ãƒˆå†…å®¹
          å‹•ä½œç¢ºèªã‚’è¡Œã„ã€å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
          
          Fixes #${{ github.event.issue.number }}" > pr_body.txt
          
          5. â—å¿…ãšãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ï¼ˆã‚¹ã‚­ãƒƒãƒ—ä¸å¯ï¼‰
          gh pr create \
            --title "âœ¨ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" \
            --body-file pr_body.txt \
            --base main \
            --head $BRANCH_NAME
          
          # PRãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
          PR_URL=$(gh pr view --json url -q .url)
          echo "âœ… PRã‚’ä½œæˆã—ã¾ã—ãŸ: $PR_URL"
          
          6. Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
          echo "ğŸ‰ PRä½œæˆå®Œäº†ã—ã¾ã—ãŸï¼
          
          ğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™
          ğŸ”— PR: $PR_URL
          
          ### ğŸ“‹ å¯¾å¿œæ¦‚è¦
          ${{ github.event.issue.title }}ã«å¯¾å¿œã™ã‚‹PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼" > comment.txt
          
          gh issue comment ${{ github.event.issue.number }} --body-file comment.txt
          
          # é‡è¦ï¼šå…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèª
          echo "âœ… å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼š"
          echo "  - ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: âœ“"
          echo "  - ã‚³ãƒŸãƒƒãƒˆ: âœ“"
          echo "  - ãƒ—ãƒƒã‚·ãƒ¥: âœ“"
          echo "  - PRä½œæˆ: âœ“"
          echo "  - Issueã‚³ãƒ¡ãƒ³ãƒˆ: âœ“"
          EOF
          
          # Codexã«å‡¦ç†ã•ã›ã‚‹
          codex --full-auto --quiet --model o3 "$(cat pr_prompt.txt)"
